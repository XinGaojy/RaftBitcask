# Bitcask-cpp å¤‡ä»½æµ‹è¯•å®Œæ•´ä¿®å¤æ€»ç»“

## ðŸŽ¯ é—®é¢˜åˆ†æž

é€šè¿‡è¯¦ç»†çš„è°ƒè¯•è¾“å‡ºï¼Œæˆ‘ä»¬å‘çŽ°äº†æ ¹æœ¬é—®é¢˜ï¼š

### é—®é¢˜çŽ°è±¡
1. **åŽŸå§‹æ•°æ®åº“**ï¼š`index_->size() = 5000`ï¼ˆæ­£å¸¸å†™å…¥ï¼‰
2. **æ–‡ä»¶å¤‡ä»½**ï¼šæ–‡ä»¶æ­£ç¡®å¤åˆ¶ï¼Œå¤§å° 1048506 å­—èŠ‚ï¼ˆæ•°æ®å­˜åœ¨ï¼‰
3. **æ¢å¤åŠ è½½**ï¼š`æ–‡ä»¶ 0 å¤„ç†å®Œæˆï¼Œè®°å½•æ•°ï¼š0`ï¼ˆç´¢å¼•é‡å»ºå¤±è´¥ï¼‰

### æ ¹æœ¬åŽŸå› 
**æ´»è·ƒæ–‡ä»¶çš„å†™å…¥åç§»é‡è®¾ç½®é”™è¯¯**ï¼š
- åœ¨ `load_data_files()` ä¸­ï¼Œæ´»è·ƒæ–‡ä»¶è¢«è®¾ç½®ä¸º `active_file_->set_write_off(active_file_->file_size())`
- è¿™å¯¼è‡´åŽç»­çš„ç´¢å¼•é‡å»ºæ—¶ï¼Œè¯»å–æ“ä½œä»Žæ–‡ä»¶æœ«å°¾å¼€å§‹ï¼Œè€Œä¸æ˜¯ä»Žæ–‡ä»¶å¼€å¤´
- ç»“æžœï¼šå³ä½¿æ–‡ä»¶ä¸­æœ‰æ•°æ®ï¼Œç´¢å¼•é‡å»ºä¹Ÿè¯»ä¸åˆ°ä»»ä½•è®°å½•

## ðŸ”§ å…³é”®ä¿®å¤

### 1. ä¿®å¤æ–‡ä»¶åŠ è½½é€»è¾‘
```cpp
// åœ¨ load_data_files() ä¸­
if (i == file_ids.size() - 1) {
    // æœ€åŽä¸€ä¸ªæ–‡ä»¶æ˜¯æ´»è·ƒæ–‡ä»¶
    active_file_ = std::move(data_file);
    // æ³¨æ„ï¼šä¸è¦åœ¨è¿™é‡Œè®¾ç½®å†™å…¥åç§»ï¼Œåº”è¯¥åœ¨ç´¢å¼•é‡å»ºåŽè®¾ç½®
    // è¿™æ ·å¯ä»¥ç¡®ä¿ç´¢å¼•é‡å»ºæ—¶èƒ½ä»Žæ–‡ä»¶å¼€å¤´æ­£ç¡®è¯»å–æ‰€æœ‰æ•°æ®
} else {
    // å…¶ä»–æ˜¯æ—§æ–‡ä»¶
    older_files_[fid] = std::move(data_file);
}
```

### 2. ä¿®å¤ç´¢å¼•é‡å»ºåŽçš„åç§»è®¾ç½®
```cpp
// åœ¨ load_index_from_data_files() ä¸­
// å¦‚æžœæ˜¯æ´»è·ƒæ–‡ä»¶ï¼Œè®¾ç½®å†™å…¥åç§»åˆ°å½“å‰å¤„ç†çš„ä½ç½®ï¼ˆé€šå¸¸æ˜¯æ–‡ä»¶æœ«å°¾ï¼‰
if (active_file_ && active_file_->get_file_id() == fid) {
    active_file_->set_write_off(offset);
    std::cout << "[DEBUG] æ´»è·ƒæ–‡ä»¶ " << fid << " å†™å…¥åç§»è®¾ç½®ä¸º: " << offset << std::endl;
}
```

### 3. æ·»åŠ è¯¦ç»†è°ƒè¯•ä¿¡æ¯
- æ–‡ä»¶å¤„ç†å¼€å§‹å’Œç»“æŸçŠ¶æ€
- è®°å½•è¯»å–è¿‡ç¨‹
- ç´¢å¼•é‡å»ºç»Ÿè®¡ä¿¡æ¯
- é”™è¯¯å¼‚å¸¸è¯¦ç»†ä¿¡æ¯

## ðŸ“ ä¿®å¤æ–‡ä»¶
ä¸»è¦ä¿®æ”¹æ–‡ä»¶ï¼š`src/db.cpp`

ä¿®æ”¹çš„å…³é”®å‡½æ•°ï¼š
1. `load_data_files()` - ä¿®å¤æ´»è·ƒæ–‡ä»¶åŠ è½½é€»è¾‘
2. `load_index_from_data_files()` - ä¿®å¤ç´¢å¼•é‡å»ºå’Œåç§»è®¾ç½®
3. `set_active_data_file()` - æ·»åŠ è°ƒè¯•ä¿¡æ¯

## ðŸš€ éªŒè¯æ–¹æ³•

è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š
```bash
chmod +x test_fix_now.sh
./test_fix_now.sh
```

é¢„æœŸç»“æžœï¼š
- âœ… æ–‡ä»¶æ­£ç¡®ä»Žåç§» 0 å¼€å§‹è¯»å–
- âœ… æˆåŠŸè¯»å–åˆ°æ‰€æœ‰è®°å½•
- âœ… ç´¢å¼•æ­£ç¡®é‡å»ºï¼ŒåŒ…å«æ‰€æœ‰é”®
- âœ… å¤‡ä»½æµ‹è¯•å…¨éƒ¨é€šè¿‡

## ðŸ“Š é¢„æœŸä¿®å¤æ•ˆæžœ

ä¿®å¤å‰ï¼š
```
[DEBUG] æ–‡ä»¶ 0 å¼€å§‹ä»Žåç§» 0 è¯»å–ï¼Œæ–‡ä»¶å¤§å°: 1048506
[DEBUG] æ–‡ä»¶ 0 å¤„ç†å®Œæˆï¼Œè®°å½•æ•°ï¼š0
[DEBUG] é‡å»ºåŽç´¢å¼•å¤§å°ï¼š0
```

ä¿®å¤åŽï¼š
```
[DEBUG] æ–‡ä»¶ 0 å¼€å§‹ä»Žåç§» 0 è¯»å–ï¼Œæ–‡ä»¶å¤§å°: 1048506
[DEBUG] æ–‡ä»¶ 0 å¤„ç†å®Œæˆï¼Œè®°å½•æ•°ï¼š5000
[DEBUG] é‡å»ºåŽç´¢å¼•å¤§å°ï¼š5000
```

## ðŸŽ‰ æœ€ç»ˆç›®æ ‡
- âœ… è§£å†³åŒæ­¥é˜»å¡žé—®é¢˜
- âœ… ä¿®å¤å¤‡ä»½å’Œæ¢å¤åŠŸèƒ½
- âœ… é€šè¿‡æ‰€æœ‰8ä¸ªå¤‡ä»½æµ‹è¯•ç”¨ä¾‹
- âœ… ç¡®ä¿åœ¨Ubuntu 22.04ä¸Šæ­£å¸¸ç¼–è¯‘è¿è¡Œ
